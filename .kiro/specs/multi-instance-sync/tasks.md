# Implementation Plan

## Tasks

- [ ] 1. 基盤設定と同期設定管理機能の実装
- [ ] 1.1 (P) package.jsonへの同期設定スキーマ追加
  - 同期機能の有効/無効を切り替えるブール型設定オプションを定義する
  - 同期間隔を指定するミリ秒単位の数値型設定オプションを定義する（100ms〜5000ms範囲）
  - デフォルト値を設定（同期有効: true、間隔: 1000ms）
  - 設定の説明文を日本語と英語で定義する
  - _Requirements: 8.1, 8.3_

- [ ] 1.2 (P) 同期設定マネージャーの実装
  - VSCode設定APIから同期機能の有効/無効状態を取得する機能を実装する
  - 同期間隔の設定値を取得し、範囲内であることを検証する機能を実装する
  - 設定変更をリアルタイムで検知し、リスナーに通知するイベント購読機能を実装する
  - 無効化時に単独インスタンスモードへの移行をサポートする
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [ ] 2. 共有状態ファイル操作機能の実装
- [ ] 2.1 共有状態ファイルの基本操作機能
  - globalStorageUri配下に同期用ディレクトリ構造を作成する初期化処理を実装する
  - JSON形式でプロキシ状態（モード、URL、有効状態）を読み込む機能を実装する
  - スキーマバージョン、タイムスタンプ、変更元インスタンスIDを含む状態構造を定義する
  - ファイルが存在しない場合の初期状態作成処理を実装する
  - 依存関係: なし（基盤機能）
  - _Requirements: 5.1_

- [ ] 2.2 アトミック書き込みと破損復旧機能
  - 一時ファイルに書き込み後にリネームするアトミック書き込みパターンを実装する
  - 書き込み中のクラッシュでもファイル破損を防止する仕組みを確保する
  - JSON解析失敗時にファイルを再作成する復旧機能を実装する
  - ファイルアクセス失敗時にローカル設定を維持して動作継続するフォールバックを実装する
  - 依存関係: 2.1が完了している必要がある
  - _Requirements: 5.2, 5.5, 7.2_

- [ ] 3. ファイル変更監視機能の実装
- [ ] 3.1 ファイルウォッチャーの実装
  - Node.jsのfs.watch APIを使用した共有状態ファイルの変更監視を実装する
  - 過剰な通知を抑制するためのデバウンス処理（100ms）を実装する
  - 監視の開始と停止を制御する機能を実装する
  - ファイル変更検知時のイベント発火機能を実装する
  - Windows/macOS/Linuxでの動作差異を考慮した実装を行う
  - 依存関係: 2.1が完了している必要がある（監視対象ファイルパスが必要）
  - _Requirements: 5.3, 5.4_

- [ ] 4. インスタンス登録管理機能の実装
- [ ] 4.1 インスタンス登録・解除機能
  - 拡張機能起動時に現在のインスタンス情報（UUID、プロセスID、ウィンドウID）を登録する機能を実装する
  - 登録情報をinstances.lockファイルにJSON配列として永続化する
  - 拡張機能終了時に登録を解除するクリーンアップ処理を実装する
  - 既存のアクティブインスタンス一覧を取得する機能を実装する
  - 他にアクティブなインスタンスが存在するかを判定する機能を実装する
  - 依存関係: 2.1が完了している必要がある（保存先パスが必要）
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 4.2 ヘルスチェックとゾンビインスタンス検出機能
  - 定期的にハートビートタイムスタンプを更新する機能を実装する
  - ハートビートタイムアウト（30秒）を超えたインスタンスをゾンビとして検出する機能を実装する
  - プロセスID存在確認による追加のゾンビ検出ロジックを実装する
  - 非アクティブなインスタンスを自動的にクリーンアップする機能を実装する
  - 依存関係: 4.1が完了している必要がある
  - _Requirements: 1.4_

- [ ] 5. 競合解決機能の実装
- [ ] 5.1 (P) タイムスタンプベース競合解決ロジック
  - ローカル状態とリモート状態のタイムスタンプを比較し、最新の変更を判定する機能を実装する
  - タイムスタンプが同一の場合はリモート優先とする決定論的ルールを実装する
  - 競合発生時の詳細情報（タイムスタンプ、インスタンスID、競合タイプ）を記録する機能を実装する
  - 競合解決結果を返却し、呼び出し元に通知する仕組みを実装する
  - 未来日時のタイムスタンプを拒否するバリデーションを実装する
  - 依存関係: なし（純粋なロジックコンポーネント）
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 6. 同期マネージャーの実装
- [ ] 6.1 同期サービスのライフサイクル管理
  - 同期サービスの開始処理（インスタンス登録、ファイル監視開始）を実装する
  - 同期サービスの停止処理（インスタンス解除、リソース解放）を実装する
  - 同期が有効かどうかを判定し、無効時はスタンドアロンモードで動作する
  - 現在の同期状態（有効、アクティブインスタンス数、最終同期時刻）を取得する機能を実装する
  - 同期機能の障害が発生しても既存のプロキシ機能を維持する分離設計を確保する
  - 依存関係: 1.2, 2.1, 2.2, 3.1, 4.1, 4.2が完了している必要がある
  - _Requirements: 2.1, 2.2, 2.3, 7.1, 7.4_

- [ ] 6.2 ローカル状態変更の伝播機能
  - プロキシモード変更時に共有ファイルへ状態を書き込む機能を実装する
  - プロキシURL変更時に共有ファイルへ状態を書き込む機能を実装する
  - プロキシ有効/無効化状態変更時に共有ファイルへ状態を書き込む機能を実装する
  - 状態変更にタイムスタンプとインスタンスIDを付与する
  - 変更伝播が1秒以内に完了することを確認するパフォーマンス要件を満たす
  - 依存関係: 6.1が完了している必要がある
  - _Requirements: 2.1, 2.2, 2.3, 2.5_

- [ ] 6.3 リモート変更の検出と適用機能
  - ファイル変更通知を受信し、共有状態を読み込む機能を実装する
  - 競合解決ロジックを呼び出し、適用すべき状態を決定する機能を実装する
  - 決定された状態をローカルのProxyStateManagerに適用する機能を実装する
  - 状態適用後にStatusBarの表示を更新するイベントを発火する
  - 自身が発信した変更は無視するフィルタリングを実装する
  - 依存関係: 6.2、5.1が完了している必要がある
  - _Requirements: 2.4, 2.5, 5.3_

- [ ] 6.4 接続テスト結果の共有機能
  - プロキシ接続テスト完了時にテスト結果を共有状態に書き込む機能を実装する
  - テスト結果に成功/失敗、タイムスタンプ、テスト対象URLを含める
  - 他のインスタンスからのテスト結果を受信し、ローカル表示を更新する機能を実装する
  - テスト結果の鮮度（いつ実行されたか）を表示するための情報を提供する
  - 依存関係: 6.3が完了している必要がある
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 6.5 エラーハンドリングと自動復旧機能
  - インスタンス間通信失敗時にエラーをログに記録し、ローカル動作を継続する機能を実装する
  - 同期エラーからの自動復旧と最新設定の再同期機能を実装する
  - 30秒タイムアウト検出と再試行スケジューリング機能を実装する
  - 連続失敗カウントによるスタンドアロンモード移行（3回失敗で移行）を実装する
  - ポーリングフォールバック（fs.watch失敗時の5秒間隔ポーリング）を実装する
  - 依存関係: 6.1〜6.4が完了している必要がある
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 7. 同期状態のUI表示機能の実装
- [ ] 7.1 (P) 国際化キーの追加
  - 同期機能に関する翻訳キーを日本語ロケールファイルに追加する
  - 同期機能に関する翻訳キーを英語ロケールファイルに追加する
  - 同期状態（同期中、同期完了、エラー）、インスタンス数、競合解決の通知メッセージを定義する
  - 設定項目の説明文を多言語対応する
  - 依存関係: なし（純粋なリソースファイル追加）
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 7.2 同期ステータスプロバイダーの実装
  - 複数インスタンス検出時にステータスバーに同期アイコンを表示する機能を実装する
  - 同期中であることを視覚的に示すインジケーター（スピナーまたはアニメーション）を実装する
  - 同期エラー発生時にステータスバーに警告アイコンを表示する機能を実装する
  - ツールチップで同期状態の詳細（接続インスタンス数、最終同期時刻）を表示する
  - ステータスアイコンクリック時に詳細情報を表示するコマンドを実装する
  - 競合解決時にユーザーへ通知を表示する機能を実装する
  - 依存関係: 7.1、6.1が完了している必要がある
  - _Requirements: 4.2, 6.1, 6.2, 6.3, 6.4_

- [ ] 8. システム統合と拡張機能への組み込み
- [ ] 8.1 拡張機能初期化への統合
  - ExtensionInitializerにSyncManagerの初期化フェーズを追加する
  - ProxyMonitor初期化後、StatusBar更新前のフェーズ4.5として配置する
  - 拡張機能のdeactivate時にSyncManagerの停止処理を呼び出す
  - ProxyStateManagerとSyncManagerの連携（状態変更イベントの購読）を設定する
  - StatusBarManagerへのSyncStatusProvider統合を行う
  - 依存関係: 6.1〜6.5、7.2が完了している必要がある
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 2.4_

- [ ] 8.2 単体テストの実装
  - SyncConfigManagerの設定取得・変更検知のテストを作成する
  - SharedStateFileのアトミック書き込み・復旧処理のテストを作成する
  - InstanceRegistryの登録・解除・ゾンビ検出のテストを作成する
  - ConflictResolverのタイムスタンプ比較・エッジケースのテストを作成する
  - FileWatcherのデバウンス動作・開始/停止のテストを作成する
  - SyncManagerの状態変更通知・競合解決・エラーハンドリングのテストを作成する
  - 依存関係: 8.1が完了している必要がある
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2, 8.3, 8.4_

- [ ] 8.3 統合テストの実装
  - 2インスタンスでの同期フローをシミュレーションするテストを作成する
  - 同時変更による競合解決シナリオのテストを作成する
  - ファイル破損からの復旧シナリオのテストを作成する
  - 同期有効/無効のリアルタイム切り替えテストを作成する
  - エラー発生時のスタンドアロンモードフォールバックテストを作成する
  - 依存関係: 8.2が完了している必要がある
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 4.1, 4.2, 4.3, 4.4, 5.3, 5.5, 7.1, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2, 8.4_

- [ ]* 8.4 プロパティベーステストの実装
  - SharedStateFileの任意の有効なProxyStateがシリアライズ/デシリアライズで保持されることを検証する
  - ConflictResolverが任意の2つの状態に対して必ず勝者を決定することを検証する
  - 依存関係: 8.2が完了している必要がある
  - _Requirements: 5.2, 4.1_
