# Requirements Document

## Introduction

このドキュメントは、VSCode拡張機能「otak-proxy」のAutoモードにおけるプロキシ接続テスト機能の要件を定義します。現在の実装では、システムプロキシの設定を検出するだけで、実際にそのプロキシが疎通可能かどうかをテストしていません。その結果、プロキシサーバーがダウンしている場合や、ネットワーク環境が変わった場合（会社→自宅など）に、自動的にプロキシのON/OFFを切り替えることができません。

この機能により、Autoモード中に定期的にプロキシ接続テストを実行し、疎通可否に応じて自動的にプロキシを有効化/無効化することで、ユーザーが手動で切り替える必要をなくします。

## Glossary

- **ProxyMonitor**: システムプロキシの変更を監視し、定期的にチェックを実行するクラス
- **ProxyConnectionTester**: プロキシ接続のテストを実行するクラス
- **Auto Mode**: システムプロキシ設定を自動的に検出して使用するモード
- **Connection Test**: プロキシ経由で外部URLに接続できるかを確認するテスト
- **Parallel Testing**: 複数のテストURLを同時に実行して、最初に成功したものを採用する方式
- **Test Timeout**: 接続テストの最大待機時間
- **Proxy State**: プロキシの有効/無効状態

## Requirements

### Requirement 1

**User Story:** ユーザーとして、Autoモード中にプロキシが実際に疎通可能かどうかを自動的にテストしてほしいので、システムプロキシ検出時に接続テストが実行されることを望みます

#### Acceptance Criteria

1. WHEN システムプロキシが検出された場合 THEN システムはそのプロキシに対して接続テストを実行すること
2. WHEN 接続テストが成功した場合 THEN システムはプロキシを有効化すること
3. WHEN 接続テストが失敗した場合 THEN システムはプロキシを無効化し、直接接続を使用すること
4. WHEN システムプロキシが検出されない場合 THEN システムはプロキシを無効化すること

### Requirement 2

**User Story:** ユーザーとして、接続テストが高速に完了してほしいので、並列テストと短いタイムアウトが使用されることを望みます

#### Acceptance Criteria

1. WHEN 接続テストが実行される場合 THEN システムは複数のテストURLを並列に実行すること
2. WHEN 並列テスト中にいずれかのURLが成功した場合 THEN システムは即座にテストを完了し、成功を返すこと
3. WHEN 接続テストが実行される場合 THEN システムは各URLに対して3秒のタイムアウトを設定すること
4. WHEN すべてのテストURLが失敗した場合 THEN システムはテスト失敗を返すこと

### Requirement 3

**User Story:** ユーザーとして、ネットワーク環境が変わった時に自動的にプロキシ状態が更新されてほしいので、定期的な接続テストが実行されることを望みます

#### Acceptance Criteria

1. WHEN Autoモードが有効な場合 THEN システムは1分ごとに接続テストを実行すること
2. WHEN 定期テストでプロキシが疎通不可になった場合 THEN システムはプロキシを無効化すること
3. WHEN 定期テストでプロキシが疎通可能になった場合 THEN システムはプロキシを有効化すること
4. WHEN Autoモードが無効になった場合 THEN システムは定期テストを停止すること

### Requirement 4

**User Story:** ユーザーとして、VSCode起動時に即座に正しいプロキシ状態になってほしいので、起動時に接続テストが実行されることを望みます

#### Acceptance Criteria

1. WHEN VSCodeが起動しAutoモードが有効な場合 THEN システムは起動直後に接続テストを実行すること
2. WHEN 起動時のテストが成功した場合 THEN システムはプロキシを有効化すること
3. WHEN 起動時のテストが失敗した場合 THEN システムはプロキシを無効化すること
4. WHEN 起動時のテストが完了するまで THEN システムはプロキシ状態を未確定として扱うこと

### Requirement 5

**User Story:** ユーザーとして、システムプロキシ設定が変更された時に即座にテストしてほしいので、変更検知時に接続テストが実行されることを望みます

#### Acceptance Criteria

1. WHEN システムプロキシURLが変更された場合 THEN システムは即座に新しいプロキシに対して接続テストを実行すること
2. WHEN 新しいプロキシのテストが成功した場合 THEN システムは新しいプロキシを有効化すること
3. WHEN 新しいプロキシのテストが失敗した場合 THEN システムはプロキシを無効化すること
4. WHEN システムプロキシが削除された場合 THEN システムはプロキシを無効化し、テストを実行しないこと

### Requirement 6

**User Story:** ユーザーとして、プロキシ状態の変化を把握したいので、適切な通知が表示されることを望みます

#### Acceptance Criteria

1. WHEN プロキシが有効化された場合 THEN システムは成功通知を表示すること
2. WHEN プロキシが無効化された場合 THEN システムは情報通知を表示すること
3. WHEN 通知が表示される場合 THEN システムは通知の重複を抑制すること
4. WHEN 連続してプロキシ状態が変化する場合 THEN システムは最後の状態のみを通知すること

### Requirement 7

**User Story:** ユーザーとして、手動テストと自動テストを区別したいので、それぞれ異なるテスト設定が使用されることを望みます

#### Acceptance Criteria

1. WHEN ユーザーが手動でプロキシテストを実行する場合 THEN システムは5秒のタイムアウトを使用すること
2. WHEN 自動的にプロキシテストが実行される場合 THEN システムは3秒のタイムアウトを使用すること
3. WHEN 手動テストが実行される場合 THEN システムは詳細なテスト結果を表示すること
4. WHEN 自動テストが実行される場合 THEN システムは簡潔な通知のみを表示すること

### Requirement 8

**User Story:** ユーザーとして、テスト頻度を調整したいので、設定で定期テストの間隔を変更できることを望みます

#### Acceptance Criteria

1. WHEN ユーザーが設定を開く場合 THEN システムはテスト間隔の設定項目を提供すること
2. WHEN テスト間隔が変更された場合 THEN システムは新しい間隔で定期テストを実行すること
3. WHEN テスト間隔が設定される場合 THEN システムは30秒から10分の範囲で設定可能にすること
4. WHEN 設定が変更された場合 THEN システムは即座に新しい設定を適用すること
