# Implementation Plan

- [x] 1. ProxyFallbackManager クラスを実装

- [x] 1.1 ProxyFallbackManager クラスを作成
  - selectBestProxy メソッドを実装（システムプロキシとフォールバックプロキシの選択ロジック）
  - setFallbackEnabled メソッドを実装（フォールバック機能の有効/無効切り替え）
  - isFallbackEnabled メソッドを実装（フォールバック機能の状態取得）
  - 優先順位ロジック：システムプロキシ → Manualプロキシ → 直接接続
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 5.1, 5.2, 5.3, 5.4_

- [x] 1.2 ProxyFallbackManager のユニットテストを作成
  - selectBestProxy メソッドのテスト
  - システムプロキシとManualプロキシの優先順位テスト
  - フォールバック機能の有効/無効切り替えテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 5.1, 5.2, 5.3, 5.4_

- [x] 1.3 プロパティテストを作成: フォールバックプロキシの確認と選択
  - **Property 1: フォールバックプロキシの確認と選択**
  - **Validates: Requirements 1.1, 1.2, 1.5**
  - ランダムなシステムプロキシ検出結果（null）とManualプロキシURLを生成し、フォールバックロジックが正しく動作することを確認
  - 最小100回のイテレーション

- [x] 1.4 プロパティテストを作成: 優先順位ベースのプロキシ選択
  - **Property 2: 優先順位ベースのプロキシ選択**
  - **Validates: Requirements 5.1, 5.2, 5.3, 5.4**
  - ランダムなシステムプロキシとManualプロキシの組み合わせを生成し、優先順位に従ってプロキシが選択されることを確認
  - 最小100回のイテレーション

- [x] 1.5 通知機能を実装
  - フォールバック使用時の通知（「システムプロキシが検出されないため、Manualプロキシを使用しています」）
  - フォールバック失敗時の通知（「Manualプロキシも利用できません」）
  - _Requirements: 2.1, 2.4_

- [x] 1.6 プロパティテストを作成: フォールバック使用時の通知
  - **Property 3: フォールバック使用時の通知**
  - **Validates: Requirements 2.1**
  - ランダムなフォールバックプロキシ使用状況を生成し、通知が表示されることを確認
  - 最小100回のイテレーション

- [x] 1.7 プロパティテストを作成: フォールバック失敗通知
  - **Property 6: フォールバック失敗通知**
  - **Validates: Requirements 2.4**
  - ランダムなフォールバックプロキシのテスト失敗を生成し、通知が表示されることを確認
  - 最小100回のイテレーション

- [x] 2. ProxyState を拡張

- [x] 2.1 ProxyState インターフェースに新しいフィールドを追加
  - usingFallbackProxy フィールドを追加（フォールバックプロキシを使用中か）
  - autoModeOff フィールドを追加（Auto Mode OFFの状態か）
  - lastSystemProxyUrl フィールドを追加（最後に検出されたシステムプロキシURL）
  - fallbackProxyUrl フィールドを追加（現在使用中のフォールバックプロキシURL）
  - _Requirements: 3.1_

- [x] 2.2 ProxyStateManager を更新
  - 新しいフィールドの保存と読み込みをサポート
  - 既存の状態ファイルとの互換性を維持
  - _Requirements: 3.1_

- [x] 2.3 ProxyStateManager のユニットテストを更新
  - 新しいフィールドの保存と読み込みをテスト
  - 後方互換性をテスト
  - _Requirements: 3.1_

- [x] 2.4 プロパティテストを作成: Auto Mode OFF状態管理
  - **Property 7: Auto Mode OFF状態管理**
  - **Validates: Requirements 3.1**
  - ランダムなAutoモードでのプロキシ無効化を生成し、状態が正しく記録されることを確認
  - 最小100回のイテレーション

- [x] 3. ProxyMonitor にフォールバック機能を統合

- [x] 3.1 ProxyMonitor に ProxyFallbackManager を統合
  - executeCheck メソッドを拡張してフォールバックロジックを実行
  - システムプロキシ検出失敗時にフォールバックプロキシを試行
  - テスト結果に基づいてプロキシ状態を決定
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3.2 ProxyMonitor の統合テストを作成
  - フォールバック機能の統合動作をテスト
  - システムプロキシとフォールバックプロキシの切り替えをテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3.3 システムプロキシへの切り替え通知を実装
  - フォールバックプロキシからシステムプロキシへの切り替え時に通知
  - 「システムプロキシに切り替えました」というメッセージ
  - _Requirements: 2.3_

- [x] 3.4 プロパティテストを作成: システムプロキシへの切り替え通知
  - **Property 5: システムプロキシへの切り替え通知**
  - **Validates: Requirements 2.3**
  - ランダムなフォールバックからシステムプロキシへの遷移を生成し、通知が表示されることを確認
  - 最小100回のイテレーション

- [x] 3.5 Auto Mode OFF からの自動復帰を実装
  - Auto Mode OFFの状態でシステムプロキシまたはフォールバックプロキシが利用可能になった場合、自動的にプロキシを有効化
  - _Requirements: 3.2, 3.3_

- [x] 3.6 プロパティテストを作成: Auto Mode OFFからの自動復帰
  - **Property 8: Auto Mode OFFからの自動復帰**
  - **Validates: Requirements 3.2, 3.3**
  - ランダムなAuto Mode OFFからの復帰シナリオを生成し、プロキシが自動的に有効化されることを確認
  - 最小100回のイテレーション

- [x] 3.7 完全なOFFモードの動作を実装
  - 完全なOFFモードではプロキシ検出やテストを一切実行しない
  - _Requirements: 3.4_

- [x] 3.8 プロパティテストを作成: 完全なOFFモードの動作
  - **Property 9: 完全なOFFモードの動作**
  - **Validates: Requirements 3.4**
  - ランダムな完全なOFFモードの状態を生成し、プロキシ検出やテストが実行されないことを確認
  - 最小100回のイテレーション

- [x] 4. StatusBarManager にフォールバック状態の表示を追加

- [x] 4.1 StatusBarManager を更新
  - updateText メソッドを拡張してフォールバック状態を表示
  - Auto Mode OFFの場合は「Auto (OFF)」と表示
  - フォールバック使用中の場合は「Auto (Fallback)」と表示
  - 完全なOFFモードの場合は「OFF」と表示
  - _Requirements: 2.2, 4.1, 4.2_

- [x] 4.2 StatusBarManager のユニットテストを更新
  - フォールバック状態の表示をテスト
  - Auto Mode OFFの表示をテスト
  - _Requirements: 2.2, 4.1, 4.2_

- [x] 4.3 プロパティテストを作成: ステータスバー表示の正確性
  - **Property 4: ステータスバー表示の正確性**
  - **Validates: Requirements 2.2, 4.1, 4.2**
  - ランダムなプロキシ状態を生成し、ステータスバーの表示が正しいことを確認
  - 最小100回のイテレーション

- [x] 4.4 ツールチップを更新
  - updateTooltip メソッドを拡張してAuto Mode OFFと完全なOFFモードの違いを説明
  - _Requirements: 4.3_

- [x] 4.5 プロパティテストを作成: ツールチップの説明
  - **Property 10: ツールチップの説明**
  - **Validates: Requirements 4.3**
  - ランダムなプロキシ状態を生成し、ツールチップが正しい説明を含むことを確認
  - 最小100回のイテレーション

- [x] 4.6 Auto Mode OFFでのクリック動作を実装
  - Auto Mode OFFの状態でステータスバーをクリックした場合、即座に接続テストを実行
  - _Requirements: 4.4_

- [x] 4.7 プロパティテストを作成: Auto Mode OFFでのクリック動作
  - **Property 11: Auto Mode OFFでのクリック動作**
  - **Validates: Requirements 4.4**
  - ランダムなAuto Mode OFFの状態を生成し、クリック時に接続テストが実行されることを確認
  - 最小100回のイテレーション

- [x] 5. 定期テストにフォールバックロジックを追加

- [x] 5.1 ProxyTestScheduler を拡張
  - 定期テストでシステムプロキシを最初にテスト
  - システムプロキシが失敗した場合、Manualプロキシをテスト
  - テスト結果に基づいてプロキシを有効化/無効化
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 5.2 ProxyTestScheduler のユニットテストを更新
  - フォールバックロジックをテスト
  - システムプロキシとManualプロキシの順次テストをテスト
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 5.3 プロパティテストを作成: 定期テストのフォールバックロジック
  - **Property 12: 定期テストのフォールバックロジック**
  - **Validates: Requirements 6.1, 6.2, 6.3, 6.4**
  - ランダムな定期テストのシナリオを生成し、フォールバックロジックが正しく動作することを確認
  - 最小100回のイテレーション

- [x] 6. ログ記録機能を追加

- [x] 6.1 ProxyChangeLogger を拡張
  - フォールバックプロキシ使用時のログ記録（「Fallback to Manual Proxy」）
  - Auto Mode OFF切り替え時のログ記録（「Auto Mode OFF (waiting for proxy)」）
  - システムプロキシ復帰時のログ記録（「Switched back to System Proxy」）
  - _Requirements: 7.2, 7.3, 7.4_

- [x] 6.2 ProxyChangeLogger のユニットテストを更新
  - フォールバック関連のログ記録をテスト
  - _Requirements: 7.2, 7.3, 7.4_

- [x] 6.3 プロパティテストを作成: フォールバック使用のログ記録
  - **Property 13: フォールバック使用のログ記録**
  - **Validates: Requirements 7.2**
  - ランダムなフォールバックプロキシの使用を生成し、ログメッセージが正しいことを確認
  - 最小100回のイテレーション

- [x] 6.4 プロパティテストを作成: Auto Mode OFFのログ記録
  - **Property 14: Auto Mode OFFのログ記録**
  - **Validates: Requirements 7.3**
  - ランダムなAuto Mode OFFへの切り替えを生成し、ログメッセージが正しいことを確認
  - 最小100回のイテレーション

- [x] 6.5 プロパティテストを作成: システムプロキシ復帰のログ記録
  - **Property 15: システムプロキシ復帰のログ記録**
  - **Validates: Requirements 7.4**
  - ランダムなシステムプロキシへの復帰を生成し、ログメッセージが正しいことを確認
  - 最小100回のイテレーション

- [x] 7. 設定項目を追加

- [x] 7.1 package.json に設定項目を追加
  - otakProxy.enableFallback 設定を追加（デフォルトtrue）
  - 英語と日本語の説明を追加
  - _Requirements: 8.1_

- [x] 7.2 設定変更のリスナーを実装
  - enableFallback 変更時に ProxyFallbackManager を更新
  - _Requirements: 8.4_

- [x] 7.3 フォールバック機能の無効化を実装
  - フォールバック機能が無効化されている場合、Manualプロキシをフォールバックとして使用しない
  - システムプロキシのみをテスト
  - _Requirements: 8.2, 8.3_

- [x] 7.4 プロパティテストを作成: フォールバック機能の無効化
  - **Property 16: フォールバック機能の無効化**
  - **Validates: Requirements 8.2, 8.3**
  - ランダムなフォールバック無効の状態を生成し、Manualプロキシが使用されないことを確認
  - 最小100回のイテレーション

- [x] 7.5 プロパティテストを作成: フォールバック設定の即時反映
  - **Property 17: フォールバック設定の即時反映**
  - **Validates: Requirements 8.4**
  - ランダムなフォールバック設定の変更を生成し、新しい設定が即座に適用されることを確認
  - 最小100回のイテレーション

- [x] 8. 国際化メッセージを追加

- [x] 8.1 新しいメッセージキーを追加
  - en.json と ja.json にフォールバック関連のメッセージを追加
  - 「システムプロキシが検出されないため、Manualプロキシを使用しています」
  - 「Manualプロキシも利用できません」
  - 「システムプロキシに切り替えました」
  - 「Auto (OFF)」、「Auto (Fallback)」のステータスバーテキスト
  - ツールチップの説明
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 4.1, 4.2, 4.3_

- [x] 9. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 10. 統合テストを作成

- [x] 10.1 フォールバックプロキシ使用フローの統合テストを作成
  - システムプロキシ検出失敗 → Manualプロキシ確認 → 接続テスト → フォールバックプロキシ有効化 → 通知表示のフローをテスト
  - _Requirements: 1.1, 1.2, 1.3, 2.1_

- [x] 10.2 システムプロキシ復帰フローの統合テストを作成
  - フォールバックプロキシ使用中 → システムプロキシ検出 → 接続テスト → システムプロキシ有効化 → 通知表示のフローをテスト
  - _Requirements: 2.3, 5.2_

- [x] 10.3 Auto Mode OFF フローの統合テストを作成
  - 両方のプロキシ失敗 → Auto Mode OFF → システムプロキシ検出 → 自動復帰 → プロキシ有効化のフローをテスト
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 10.4 フォールバック機能無効化フローの統合テストを作成
  - フォールバック無効設定 → システムプロキシ検出失敗 → Manualプロキシを試行しない → Auto Mode OFFのフローをテスト
  - _Requirements: 8.2, 8.3_

- [x] 11. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する
