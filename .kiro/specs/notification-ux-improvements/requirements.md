# Requirements Document

## Introduction

このドキュメントは、VSCode拡張機能「otak-proxy」の通知とユーザーエクスペリエンスの改善に関する要件を定義します。現在の実装では、エラーメッセージが長すぎて読みにくい、通知が自動で閉じない、重要な情報が埋もれてしまうなどの問題があります。これらの問題を解決し、より使いやすいインターフェースを提供することを目的としています。

## Glossary

- **UserNotifier**: ユーザーへの通知を管理するクラス。エラー、成功、警告メッセージを表示する
- **StatusBarManager**: VSCodeのステータスバーアイテムを管理し、プロキシの状態を表示するクラス
- **Notification**: VSCodeのウィンドウに表示されるメッセージ（エラー、情報、警告）
- **Toast**: 自動的に消える短い通知メッセージ
- **Action Button**: 通知に表示されるクリック可能なボタン
- **Progress Notification**: 進行状況を表示する通知
- **Output Channel**: VSCodeの出力パネルに表示される詳細ログ

## Requirements

### Requirement 1

**User Story:** ユーザーとして、エラーメッセージを素早く理解したいので、簡潔で読みやすい通知が表示されることを望みます

#### Acceptance Criteria

1. WHEN エラーが発生した場合 THEN システムは主要なエラーメッセージのみを通知に表示し、詳細情報は別の場所に配置すること
2. WHEN 複数の提案がある場合 THEN システムは通知に最も重要な提案のみを表示し、残りは詳細ビューに配置すること
3. WHEN 長いURLリストがある場合 THEN システムは通知に要約のみを表示し、完全なリストは出力チャネルに記録すること
4. WHEN エラーメッセージが表示される場合 THEN システムはメッセージの長さを200文字以内に制限すること

### Requirement 2

**User Story:** ユーザーとして、成功メッセージが自動的に消えることを望むので、手動で閉じる手間を省きたい

#### Acceptance Criteria

1. WHEN 成功メッセージが表示される場合 THEN システムは3秒後に自動的に通知を閉じること
2. WHEN 情報メッセージが表示される場合 THEN システムは5秒後に自動的に通知を閉じること
3. WHEN エラーメッセージが表示される場合 THEN システムはユーザーが手動で閉じるまで通知を表示し続けること
4. WHEN 警告メッセージが表示される場合 THEN システムは10秒後に自動的に通知を閉じること

### Requirement 3

**User Story:** ユーザーとして、詳細情報を必要に応じて確認したいので、「詳細を表示」ボタンが提供されることを望みます

#### Acceptance Criteria

1. WHEN エラー通知が表示される場合 THEN システムは「詳細を表示」アクションボタンを提供すること
2. WHEN 「詳細を表示」ボタンがクリックされた場合 THEN システムは出力チャネルを開き、完全なエラー情報を表示すること
3. WHEN 詳細情報が出力チャネルに記録される場合 THEN システムはタイムスタンプ、エラーメッセージ、スタックトレース、試行されたURLを含めること
4. WHEN テストが失敗した場合 THEN システムは試行されたすべてのURLとそれぞれのエラーを出力チャネルに記録すること

### Requirement 4

**User Story:** ユーザーとして、プロキシテスト中の進行状況を視覚的に確認したいので、適切な進行状況表示が提供されることを望みます

#### Acceptance Criteria

1. WHEN プロキシテストが開始される場合 THEN システムは進行状況通知を表示すること
2. WHEN 複数のURLをテストする場合 THEN システムは現在テスト中のURL番号と総数を表示すること
3. WHEN テストが完了した場合 THEN システムは進行状況通知を自動的に閉じ、結果通知を表示すること
4. WHEN テストに5秒以上かかる場合 THEN システムはキャンセル可能な進行状況通知を表示すること

### Requirement 5

**User Story:** ユーザーとして、通知の重要度を視覚的に区別したいので、適切なアイコンと色が使用されることを望みます

#### Acceptance Criteria

1. WHEN 成功メッセージが表示される場合 THEN システムはチェックマークアイコンを使用すること
2. WHEN エラーメッセージが表示される場合 THEN システムは警告アイコンを使用すること
3. WHEN 情報メッセージが表示される場合 THEN システムは情報アイコンを使用すること
4. WHEN 警告メッセージが表示される場合 THEN システムは注意アイコンを使用すること

### Requirement 6

**User Story:** ユーザーとして、通知からすぐにアクションを実行したいので、関連するアクションボタンが提供されることを望みます

#### Acceptance Criteria

1. WHEN プロキシが設定されていないエラーが表示される場合 THEN システムは「手動設定」と「システムからインポート」のアクションボタンを提供すること
2. WHEN プロキシテストが失敗した場合 THEN システムは「再テスト」と「設定を変更」のアクションボタンを提供すること
3. WHEN システムプロキシが検出されない場合 THEN システムは「手動設定」と「再検出」のアクションボタンを提供すること
4. WHEN アクションボタンがクリックされた場合 THEN システムは対応するコマンドを実行し、通知を閉じること

### Requirement 7

**User Story:** ユーザーとして、通知の頻度を制御したいので、同じメッセージが短時間に複数回表示されないことを望みます

#### Acceptance Criteria

1. WHEN 同じエラーメッセージが5秒以内に発生した場合 THEN システムは重複する通知を抑制すること
2. WHEN 通知が抑制された場合 THEN システムは出力チャネルにすべてのイベントを記録すること
3. WHEN システムプロキシの変更が検出された場合 THEN システムは最後の通知から30秒以上経過している場合のみ通知を表示すること
4. WHEN 連続して失敗が発生した場合 THEN システムは最初の失敗と5回目の失敗のみを通知すること

### Requirement 8

**User Story:** ユーザーとして、ステータスバーから素早く情報を確認したいので、ツールチップが簡潔で読みやすいことを望みます

#### Acceptance Criteria

1. WHEN ステータスバーアイテムにホバーした場合 THEN システムは現在のモード、ステータス、アクティブなプロキシURLを表示すること
2. WHEN Autoモードの場合 THEN システムは最終チェック時刻と検出ソースを表示すること
3. WHEN エラーがある場合 THEN システムは最後のエラーメッセージを1行で表示すること
4. WHEN ツールチップが表示される場合 THEN システムはコマンドリンクを視覚的に区別して表示すること
