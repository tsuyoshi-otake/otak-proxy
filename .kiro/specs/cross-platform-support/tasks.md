# Implementation Plan

## Task 1. テストモッキングユーティリティの実装
- [x] 1.1 (P) プラットフォームモッカーの実装
  - process.platformプロパティを安全にモック/リストアするユーティリティを作成する
  - Sinon sandboxを使用してwin32、darwin、linuxの3つのプラットフォーム値をモック可能にする
  - テスト終了時の確実なリストアとテスト間での状態分離を保証する
  - Object.definePropertyを使用したplatformプロパティの書き換えパターンを適用する
  - _Requirements: 9.4_

- [x] 1.2 (P) コマンドモッカーの実装
  - child_process.execおよびexecFileのモック化ユーティリティを作成する
  - 成功レスポンス（stdout/stderr）の注入機能を実装する
  - エラーレスポンス（ENOENT、EACCES、タイムアウト）のシミュレーション機能を実装する
  - 複数コマンドの一括モック設定機能を実装する
  - stub.yields()を使用したコールバック結果注入パターンを適用する
  - _Requirements: 9.1, 9.2_

## Task 2. クロスプラットフォーム検出テストの実装
- [x] 2.1 Windowsレジストリ検出テストの実装
  - プラットフォームモッカーを使用してwin32環境をシミュレートする
  - reg queryコマンドのモック出力を設定し、ProxyEnable=1のケースをテストする
  - ProxyEnable=0（プロキシ無効）のケースをテストする
  - "http=proxy:port;https=proxy:port"形式のプロキシ値解析をテストする
  - "proxy:port"形式のシンプルなプロキシ値解析をテストする
  - プラットフォーム検出がwin32を正しく識別することを確認する
  - _Requirements: 1.1, 1.2, 1.4, 2.1, 2.2, 2.3_

- [x] 2.2 (P) macOS networksetup検出テストの実装
  - プラットフォームモッカーを使用してdarwin環境をシミュレートする
  - networksetupコマンドのモック出力を設定し、Wi-Fiプロキシ有効ケースをテストする
  - Ethernetプロキシ有効ケースをテストする
  - Thunderbolt Ethernetインターフェースのテストを追加する
  - プロキシ無効（Enabled: No）のケースをテストする
  - ネットワークインターフェース未存在時の次インターフェース検出動作をテストする
  - サーバーとポートからhttp://server:port形式への変換をテストする
  - Task 2.1とは独立して実行可能（プラットフォームごとのテストファイルで分離）
  - _Requirements: 1.1, 1.2, 1.4, 3.1, 3.2, 3.3, 3.4_

- [x] 2.3 (P) Linux gsettings検出テストの実装
  - プラットフォームモッカーを使用してlinux環境をシミュレートする
  - gsettingsコマンドのモック出力を設定し、mode='manual'のケースをテストする
  - org.gnome.system.proxy.httpからのホストとポート取得をテストする
  - mode='auto'（非対応）のケースをテストする
  - gsettings未インストール時のエラーハンドリングをテストする
  - ホストとポートからhttp://host:port形式への変換をテストする
  - Task 2.1、2.2とは独立して実行可能
  - _Requirements: 1.1, 1.2, 1.4, 4.1, 4.2, 4.3, 4.4_

## Task 3. 設定マネージャのクロスプラットフォームテスト実装
- [x] 3.1 (P) Git設定マネージャのクロスプラットフォームテスト
  - 各プラットフォームでのgit config --globalコマンド実行をテストする
  - execFileによる直接コマンド実行（シェル不使用）の動作をテストする
  - プロキシ設定（http.proxy、https.proxy）の読み書きをテストする
  - グローバル設定ファイルパスがプラットフォームに応じて正しく解決されることをテストする
  - _Requirements: 2.4, 3.5, 4.5, 8.3_

- [x] 3.2 (P) npm設定マネージャのクロスプラットフォームテスト
  - 各プラットフォームでのnpm configコマンド実行をテストする
  - isWindowsフラグによるシェル実行オプション制御をテストする
  - プロキシ設定（proxy、https-proxy）の読み書きをテストする
  - npmrc設定ファイルパスがプラットフォームに応じて正しく解決されることをテストする
  - _Requirements: 2.5, 3.6, 4.6, 8.4_

- [x] 3.3 (P) ターミナル環境設定マネージャのクロスプラットフォームテスト
  - 各プラットフォームでの統合ターミナル環境変数設定をテストする
  - VSCode API抽象化によるプラットフォーム非依存動作をテストする
  - HTTP_PROXY、HTTPS_PROXY、NO_PROXY環境変数の設定をテストする
  - _Requirements: 2.6, 3.7, 4.7_

## Task 4. エラーケーステストの実装
- [x] 4.1 (P) コマンド未存在エラーテストの実装
  - git未インストール時のENOENTエラー処理をテストする
  - npm未インストール時のENOENTエラー処理をテストする
  - Windowsのreg query未存在時のエラー処理をテストする
  - macOSのnetworksetup未存在時のエラー処理をテストする
  - Linuxのgsettings未存在時のエラー処理をテストする
  - エラー発生時にnullを返却しエラーログが記録されることを確認する
  - _Requirements: 6.1, 6.2, 6.3, 6.6, 9.2_

- [x] 4.2 (P) タイムアウトエラーテストの実装
  - gitコマンドタイムアウト（error.killed=true）の処理をテストする
  - npmコマンドタイムアウトの処理をテストする
  - レジストリクエリタイムアウトの処理をテストする
  - タイムアウト時のエラーログ記録を確認する
  - _Requirements: 6.1, 6.2, 6.6, 9.2_

- [x] 4.3 (P) 権限エラーテストの実装
  - gitコマンドの権限拒否（error.code='EACCES'）処理をテストする
  - npmコマンドの権限拒否処理をテストする
  - 権限エラー時のエラーログ記録を確認する
  - _Requirements: 6.6, 9.2_

- [x] 4.4 不正出力形式テストの実装
  - Windowsレジストリの不正出力形式の処理をテストする
  - macOS networksetupの不正出力形式の処理をテストする
  - Linux gsettingsの不正出力形式の処理をテストする
  - 不正出力時に次の検出ソースにフォールバックすることをテストする
  - Task 4.1-4.3のモックパターンを再利用するため順次実行
  - _Requirements: 6.4, 6.5, 9.2_

## Task 5. 検出優先順位とフォールバックテストの実装
- [x] 5.1 検出優先順位テストの実装
  - デフォルト優先順位（environment, vscode, platform）での検出動作をテストする
  - 環境変数（HTTP_PROXY、HTTPS_PROXY）検出時にプラットフォーム固有検出をスキップすることをテストする
  - VSCode設定検出時にプラットフォーム固有検出をスキップすることをテストする
  - 検出優先順位の動的更新機能をテストする
  - updateDetectionPriorityインターフェースの動作を検証する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 5.2 フォールバック動作テストの実装
  - 上位検出ソース失敗時のプラットフォーム固有検出へのフォールバックをテストする
  - プラットフォーム固有検出失敗時の環境変数/VSCode設定へのフォールバックをテストする
  - 全検出ソース失敗時に{ proxyUrl: null, source: null }を返却することをテストする
  - 複数ソース間のエラー時の切り替え動作をテストする
  - Task 5.1の検出優先順位設定に依存するため順次実行
  - _Requirements: 5.4, 6.4, 6.5_

## Task 6. URL検証とプロパティベーステストの実装
- [x] 6.1 (P) プロキシURL検証テストの実装
  - ProxyUrlValidatorによる検出URLの検証をテストする
  - 無効なプロキシURL検出時の警告ログ出力と次ソース試行をテストする
  - 全プラットフォームで一貫したURL検証ロジックの適用をテストする
  - 検証合格URLのみの返却をテストする
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 6.2 (P) プロパティベーステストの実装
  - fast-checkを使用したランダムなプロキシURL形式での検証動作をテストする
  - 各プラットフォームでの一貫した動作をプロパティテストで確認する
  - エッジケース自動発見のためのジェネレータを設定する
  - 既存のfast-checkテストパターンを拡張する
  - _Requirements: 9.1, 9.3_

## Task 7. テスト統合と品質確認
- [x] 7.1 全テストの統合確認とカバレッジ検証
  - 全テストスイートの一括実行と動作確認を行う
  - SystemProxyDetectorの各プラットフォームメソッドのカバレッジを確認する
  - ConfigManagersのエラーハンドリングパスのカバレッジを確認する
  - 行カバレッジ90%以上の達成を確認する
  - 全要件（1-9）のテストカバレッジマッピングを最終確認する
  - Task 1-6の完了後に実行
  - _Requirements: 9.1, 9.2, 9.3, 9.4_
