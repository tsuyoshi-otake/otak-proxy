# 要件定義書

## はじめに

本拡張機能のAutoモードは、システムプロキシ設定を自動的に検出して適用する機能を提供しています。現在の実装では1分間隔でのポーリングとウィンドウフォーカス時のチェックを行っていますが、ネットワーク環境の変化に対する応答性を向上させ、より迅速かつ確実にプロキシ設定を適用できるようにします。

## 用語集

- **Autoモード**: システムプロキシ設定を自動的に検出して適用するモード
- **システムプロキシ**: OS やブラウザが使用しているプロキシ設定
- **SystemProxyDetector**: システムプロキシを検出するクラス
- **プロキシ変更検出**: システムプロキシ設定の変更を検知する機能
- **ポーリング間隔**: システムプロキシをチェックする時間間隔
- **システム**: 本拡張機能全体を指す
- **ネットワーク切り替え**: Wi-Fi、有線LAN、VPNなどのネットワーク接続の変更

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、ネットワーク環境が変わったときに即座にプロキシ設定が更新されるように、より頻繁なプロキシチェックを実行してほしい

#### 受入基準

1. WHEN Autoモードが有効である THEN システムは30秒間隔でシステムプロキシをチェックする
2. WHEN ポーリング間隔を変更する THEN システムは既存のインターバルをクリアして新しいインターバルを設定する
3. WHEN システムプロキシのチェックに失敗する THEN システムはエラーをログに記録し、次回のチェックを継続する
4. WHEN Autoモード以外のモードに切り替える THEN システムはポーリングを停止する

### 要件 2

**ユーザーストーリー:** 開発者として、プロキシ設定の変更を見逃さないように、複数のトリガーでプロキシチェックが実行されるようにしてほしい

#### 受入基準

1. WHEN VSCodeウィンドウがフォーカスを取得する THEN システムはシステムプロキシをチェックする
2. WHEN ネットワーク接続状態が変化する THEN システムはシステムプロキシをチェックする
3. WHEN 設定ファイルが変更される THEN システムはシステムプロキシをチェックする
4. WHEN 複数のトリガーが短時間に発生する THEN システムは重複チェックを防ぐためにデバウンス処理を適用する

### 要件 3

**ユーザーストーリー:** 開発者として、プロキシ検出の失敗が続いても拡張機能が正常に動作し続けるように、リトライ機能を実装してほしい

#### 受入基準

1. WHEN システムプロキシの検出に失敗する THEN システムは最大3回までリトライする
2. WHEN リトライ間隔を設定する THEN システムは指数バックオフ（1秒、2秒、4秒）を使用する
3. WHEN すべてのリトライが失敗する THEN システムはエラーをログに記録し、ユーザーに通知する
4. WHEN リトライが成功する THEN システムは検出されたプロキシを適用し、リトライカウンターをリセットする

### 要件 4

**ユーザーストーリー:** 開発者として、プロキシ設定の変更履歴を確認できるように、変更イベントをログに記録してほしい

#### 受入基準

1. WHEN システムプロキシが変更される THEN システムは変更前と変更後のプロキシURLをログに記録する
2. WHEN プロキシが検出されなくなる THEN システムはプロキシ削除イベントをログに記録する
3. WHEN プロキシチェックが実行される THEN システムはチェック時刻と結果をログに記録する
4. WHEN ログに記録する THEN システムはInputSanitizerを使用してクレデンシャルをマスクする

### 要件 5

**ユーザーストーリー:** 開発者として、プロキシ検出の動作を理解できるように、ステータスバーに詳細な情報を表示してほしい

#### 受入基準

1. WHEN Autoモードが有効である THEN システムはステータスバーに最終チェック時刻を表示する
2. WHEN システムプロキシが検出される THEN システムはステータスバーにプロキシURLと検出ソースを表示する
3. WHEN プロキシ検出に失敗する THEN システムはステータスバーに失敗理由を表示する
4. WHEN ステータスバーをクリックする THEN システムは詳細情報を含むツールチップを表示する

### 要件 6

**ユーザーストーリー:** 開発者として、プロキシ検出の設定をカスタマイズできるように、設定オプションを提供してほしい

#### 受入基準

1. WHEN ユーザーが設定を開く THEN システムはポーリング間隔の設定オプションを提供する
2. WHEN ポーリング間隔を変更する THEN システムは10秒から300秒の範囲で値を受け入れる
3. WHEN 無効な値が入力される THEN システムはデフォルト値（30秒）を使用する
4. WHEN 設定が変更される THEN システムは即座に新しい設定を適用する

### 要件 7

**ユーザーストーリー:** 開発者として、プロキシ検出の信頼性を向上させるために、検出ソースの優先順位を設定できるようにしてほしい

#### 受入基準

1. WHEN システムプロキシを検出する THEN システムは設定された優先順位に従って検出ソースをチェックする
2. WHEN 優先順位の高いソースで検出に失敗する THEN システムは次の優先順位のソースを試行する
3. WHEN すべてのソースで検出に失敗する THEN システムはnullを返す
4. WHEN 検出ソースの優先順位を変更する THEN システムは設定ファイルから優先順位を読み込む
