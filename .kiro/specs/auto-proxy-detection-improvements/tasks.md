# 実装計画

- [x] 1. ProxyMonitorStateクラスの実装
  - 監視状態を管理する新しいクラスを作成
  - チェック成功/失敗の記録機能
  - 失敗カウンターの管理
  - _要件: 1.3, 3.1, 3.4_

- [x] 1.1 ProxyMonitorStateのユニットテストを作成
  - 状態の記録と取得をテスト
  - 失敗カウンターの管理をテスト
  - 状態のリセットをテスト
  - _要件: 1.3, 3.1, 3.4_

- [x] 2. ProxyChangeLoggerクラスの実装
  - プロキシ変更履歴を記録する新しいクラスを作成
  - InputSanitizerを使用したクレデンシャルマスキング
  - 履歴サイズの制限（最大100イベント）
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [x] 2.1 ProxyChangeLoggerのユニットテストを作成
  - イベントの記録をテスト
  - 履歴の取得をテスト
  - クレデンシャルマスキングをテスト
  - 履歴サイズの制限をテスト
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [x] 2.2 プロパティテスト: クレデンシャルマスキング





  - **Property 11: ログ記録時のクレデンシャルマスキング**
  - **検証対象: 要件 4.4**
  - 任意のクレデンシャル付きプロキシURLに対して、ログに記録される値がマスクされていることを検証
  - _要件: 4.4_

- [x] 3. ProxyMonitorクラスの基本実装
  - プロキシ監視を統合管理する新しいクラスを作成
  - 設定の管理（ポーリング間隔、デバウンス遅延、リトライ設定）
  - start()とstop()メソッドの実装
  - _要件: 1.1, 1.2, 1.4_

- [x] 3.1 ProxyMonitorの基本ユニットテストを作成
  - start()とstop()の動作をテスト
  - 設定の管理をテスト
  - _要件: 1.1, 1.2, 1.4_

- [x] 4. ポーリング機能の実装
  - setIntervalを使用したポーリングの実装
  - ポーリング間隔の動的更新機能
  - Autoモード以外でのポーリング停止
  - _要件: 1.1, 1.2, 1.4_

- [x] 4.1 プロパティテスト: ポーリング間隔の遵守





  - **Property 1: ポーリング間隔の遵守**
  - **検証対象: 要件 1.1**
  - 任意の有効なポーリング間隔（10秒から300秒）に対して、その間隔でチェックが実行されることを検証
  - _要件: 1.1_


- [x] 4.2 プロパティテスト: ポーリング間隔の動的更新




  - **Property 2: ポーリング間隔の動的更新**
  - **検証対象: 要件 1.2**
  - 任意の有効なポーリング間隔に対して、設定変更後に新しい間隔でチェックが実行されることを検証
  - _要件: 1.2_


- [x] 4.3 プロパティテスト: モード切り替え時のポーリング停止








  - **Property 4: モード切り替え時のポーリング停止**
  - **検証対象: 要件 1.4**
  - 任意のAutoモード以外のモードに対して、モード切り替え時にポーリングが停止することを検証
  - _要件: 1.4_

- [x] 5. デバウンス機能の実装
  - triggerCheck()メソッドの実装
  - デバウンスタイマーの管理
  - 複数トリガーの統合処理
  - _要件: 2.1, 2.2, 2.3, 2.4_



- [x] 5.1 プロパティテスト: デバウンス処理







  - **Property 5: デバウンス処理**
  - **検証対象: 要件 2.4**
  - 任意の複数のトリガーイベントに対して、デバウンス期間内では1回のみチェックが実行されることを検証
  - _要件: 2.4_

- [x] 6. リトライロジックの実装
  - detectWithRetry()メソッドの実装
  - 指数バックオフの実装
  - リトライカウンターの管理
  - リトライ成功時の状態リセット
  - _要件: 3.1, 3.2, 3.3, 3.4_


- [x] 6.1 プロパティテスト: リトライ回数の遵守








  - **Property 6: リトライ回数の遵守**
  - **検証対象: 要件 3.1**
  - 任意の検出失敗に対して、設定された最大リトライ回数まで再試行することを検証
  - _要件: 3.1_


- [x] 6.2 プロパティテスト: 指数バックオフ






  - **Property 7: 指数バックオフ**
  - **検証対象: 要件 3.2**
  - 任意のリトライ試行に対して、待機時間が指数的に増加することを検証
  - _要件: 3.2_


- [x] 6.3 プロパティテスト: リトライ成功時のリセット

  - **Property 8: リトライ成功時のリセット**
  - **検証対象: 要件 3.4**
  - 任意のリトライ成功に対して、リトライカウンターがリセットされることを検証
  - _要件: 3.4_

- [x] 7. プロキシチェック実行機能の実装
  - executeCheck()メソッドの実装
  - SystemProxyDetectorとの統合
  - ProxyChangeLoggerへのログ記録
  - ProxyMonitorStateの更新
  - _要件: 1.3, 4.1, 4.3_


- [x] 7.1 プロパティテスト: チェック失敗時の継続

  - **Property 3: チェック失敗時の継続**
  - **検証対象: 要件 1.3**
  - 任意のチェック失敗に対して、エラーがログに記録され、次回のポーリングが継続されることを検証

  - _要件: 1.3_

- [x] 7.2 プロパティテスト: プロキシ変更のログ記録

  - **Property 9: プロキシ変更のログ記録**
  - **検証対象: 要件 4.1**





  - 任意のプロキシ変更に対して、変更前後のURLがログに記録されることを検証
  - _要件: 4.1_

- [x] 7.3 プロパティテスト: チェック実行のログ記録

  - **Property 10: チェック実行のログ記録**
  - **検証対象: 要件 4.3**
  - 任意のプロキシチェック実行に対して、チェック時刻、結果、検出ソースがログに記録されることを検証
  - _要件: 4.3_


- [x] 8. SystemProxyDetectorの拡張
  - 検出ソース優先順位機能の追加
  - detectSystemProxyWithSource()メソッドの実装
  - updateDetectionPriority()メソッドの実装
  - _要件: 7.1, 7.2, 7.3, 7.4_




- [x] 8.1 SystemProxyDetector拡張のユニットテストを作成

  - 優先順位に従った検出をテスト


  - 検出ソースの情報返却をテスト
  - 優先順位の動的更新をテスト
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 8.2 プロパティテスト: 検出ソースの優先順位遵守


  - **Property 14: 検出ソースの優先順位遵守**
  - **検証対象: 要件 7.1**
  - 任意の検出ソース優先順位リストに対して、リストの順序に従ってチェックが実行されることを検証
  - _要件: 7.1_



- [x] 8.3 プロパティテスト: 検出失敗時のフォールバック
  - **Property 15: 検出失敗時のフォールバック**
  - **検証対象: 要件 7.2, 7.4**
  - 任意の検出ソース優先順位リストに対して、優先順位の高いソースで失敗した場合、次のソースが試行されることを検証
  - _要件: 7.2, 7.4_


- [x] 9. extension.tsへのProxyMonitor統合

  - ProxyMonitorインスタンスの作成
  - イベントハンドラーの設定（proxyChangedイベント）
  - activate()関数での初期化
  - 既存のstartSystemProxyMonitoring()の置き換え
  - _要件: 1.1, 1.4, 4.1_

- [x] 10. 設定変更リスナーの実装

  - otakProxy.pollingIntervalの変更検出

  - otakProxy.detectionSourcePriorityの変更検出
  - otakProxy.maxRetriesの変更検出
  - ProxyMonitorへの設定更新
  - _要件: 1.2, 6.4, 7.4_

- [x] 10.1 プロパティテスト: 設定変更の即時適用

  - **Property 13: 設定変更の即時適用**
  - **検証対象: 要件 6.4**
  - 任意の有効な設定値に対して、設定変更後に即座に新しい設定が適用されることを検証
  - _要件: 6.4_

- [x] 11. ポーリング間隔の範囲検証機能の実装
  - 設定値の範囲チェック（10秒から300秒）
  - 範囲外の値に対するデフォルト値の適用
  - 警告ログの記録
  - _要件: 6.2, 6.3_

- [x] 11.1 プロパティテスト: ポーリング間隔の範囲検証
  - **Property 12: ポーリング間隔の範囲検証**
  - **検証対象: 要件 6.2, 6.3**
  - 任意のポーリング間隔値に対して、範囲内なら受け入れ、範囲外ならデフォルト値が使用されることを検証
  - _要件: 6.2, 6.3_

- [x] 12. ステータスバーの拡張
  - 最終チェック時刻の表示
  - 検出ソースの表示
  - エラー情報の表示
  - ツールチップの拡張
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 13. package.jsonへの設定項目追加
  - otakProxy.pollingIntervalの追加
  - otakProxy.detectionSourcePriorityの追加
  - otakProxy.maxRetriesの追加
  - 設定の説明とデフォルト値の設定
  - _要件: 6.1, 6.2, 7.1_

- [x] 14. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる

- [x] 15. 統合テストの作成
  - Autoモード有効化フローのテスト
  - プロキシ変更検出フローのテスト
  - 設定変更フローのテスト
  - エラーリカバリーフローのテスト
  - _要件: すべて_

- [x] 16. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる
