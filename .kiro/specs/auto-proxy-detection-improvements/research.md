# 調査・設計決定ログ

## サマリー
- **機能**: auto-proxy-detection-improvements
- **ディスカバリースコープ**: Extension（既存システムの拡張）
- **主要な発見**:
  - VSCode APIにはネットワーク接続変更を検出するネイティブイベントが存在しない
  - デバウンスパターンはキャンセル機能付きの型安全な実装が推奨される
  - 指数バックオフは1秒、2秒、4秒の固定パターンで実装する

## 調査ログ

### VSCode ネットワーク変更検出API

- **調査背景**: 要件2.2「ネットワーク接続状態が変化する THEN システムはシステムプロキシをチェックする」の実現可能性調査
- **参照ソース**:
  - [VSCode Network Connections](https://code.visualstudio.com/docs/setup/network)
  - [VSCode Extension API](https://code.visualstudio.com/api/references/vscode-api)
- **発見事項**:
  - VSCode Extension APIにはネットワーク接続状態変更を通知するネイティブイベントがない
  - VSCodeはChromiumのネットワークスタックを使用し、システムネットワーク設定を利用
  - 代替アプローチとしてNode.js APIまたはポーリングが必要
- **設計への影響**:
  - ネットワーク変更検出はポーリング間隔の短縮（60秒→30秒）で対応
  - 将来的にNode.js `os.networkInterfaces()` を使用した検出も検討可能

### デバウンスパターン実装

- **調査背景**: 要件2.4「複数のトリガーが短時間に発生する THEN システムは重複チェックを防ぐためにデバウンス処理を適用する」
- **参照ソース**:
  - [TypeScript Debounce GitHub Gist](https://gist.github.com/ca0v/73a31f57b397606c9813472f7493a940)
  - [ts-debounce Library](https://github.com/chodorowicz/ts-debounce)
- **発見事項**:
  - 型安全な実装には `Parameters<T>` と `ReturnType<T>` ユーティリティ型を使用
  - キャンセル機能が重要（オブジェクト破棄時のクリーンアップ用）
  - `maxWait` オプションで最大待機時間を設定可能
- **設計への影響**:
  - 独自のデバウンスユーティリティを実装（外部依存を避ける）
  - デバウンス時間は500ms、最大待機時間は5秒に設定

### 指数バックオフ・リトライパターン

- **調査背景**: 要件3.1-3.4のリトライ機能実装
- **参照ソース**:
  - [exponential-backoff npm](https://www.npmjs.com/package/exponential-backoff)
  - [Retrying and Exponential Backoff with Promises](https://www.bayanbennett.com/posts/retrying-and-exponential-backoff-with-promises/)
- **発見事項**:
  - 最初のリクエスト前には待機しない（成功時の遅延を避ける）
  - リトライ回数に上限を設ける（タイムアウト対策）
  - 待機時間は `Math.pow(2, attempt) * BASE` で計算
- **設計への影響**:
  - 要件通り1秒、2秒、4秒の固定間隔を使用
  - 最大3回のリトライ後はエラーログ記録とユーザー通知

### 既存コードベースパターン分析

- **調査背景**: 拡張ポイントと既存パターンの特定
- **参照ソース**: ローカルコードベース分析
- **発見事項**:
  - `SystemProxyDetector`: 既存のプロキシ検出クラス（拡張対象）
  - `Logger`: クレデンシャルマスキング付きログユーティリティ
  - `ErrorAggregator`: 複数エラーの収集・フォーマット
  - `InputSanitizer`: URL内パスワードのマスキング
  - `UserNotifier`: ユーザー通知の一元管理
  - ポーリング間隔: 現在60秒（`setInterval`使用）
  - イベント検出: `onDidChangeWindowState`, `onDidChangeConfiguration` 使用中
- **設計への影響**:
  - 既存クラスを拡張し、新機能を追加
  - Logger/InputSanitizerの使用パターンを踏襲
  - ProxyState インターフェースに新フィールドを追加

## アーキテクチャパターン評価

| オプション | 説明 | 強み | リスク/制限 | 備考 |
|-----------|------|------|------------|------|
| イベント駆動 + ポーリング | 複数トリガーとポーリングの組み合わせ | 応答性とカバレッジのバランス | 複雑性増加 | 推奨アプローチ |
| ポーリングのみ | 間隔を短縮（30秒） | シンプル、予測可能 | 変更検出に最大30秒の遅延 | フォールバック |
| リアクティブのみ | イベント駆動のみ | リソース効率が良い | VSCode APIの制限で完全なカバーは不可 | 不採用 |

## 設計決定

### 決定: ハイブリッドトリガーアプローチ

- **背景**: ネットワーク環境変化への応答性向上が要件
- **検討した代替案**:
  1. ポーリング間隔短縮のみ — シンプルだが応答性に限界
  2. イベント駆動のみ — VSCode APIの制限で実現困難
  3. ハイブリッド（ポーリング + イベント） — 両方の利点を活用
- **選択したアプローチ**: ハイブリッドトリガー
  - 30秒間隔のポーリング（バックグラウンド）
  - ウィンドウフォーカス時の即時チェック（既存）
  - 設定変更時のチェック（既存）
  - デバウンス処理で重複防止
- **理由**: 応答性とリソース効率のバランスが最適
- **トレードオフ**: コードの複雑性は増すが、ユーザー体験が向上
- **フォローアップ**: 実装後にパフォーマンス影響を検証

### 決定: 設定可能なポーリング間隔

- **背景**: 要件6で設定オプションの提供が求められている
- **検討した代替案**:
  1. 固定間隔（30秒） — シンプルだが柔軟性がない
  2. 設定可能（10-300秒） — ユーザーが調整可能
- **選択したアプローチ**: 設定可能な間隔（デフォルト30秒、範囲10-300秒）
- **理由**: 異なるネットワーク環境やユースケースに対応
- **トレードオフ**: 設定項目が増えるが、パワーユーザーに価値を提供

### 決定: 検出ソース優先順位の設定化

- **背景**: 要件7で検出ソースの優先順位設定が求められている
- **検討した代替案**:
  1. ハードコード順序 — シンプルだが柔軟性がない
  2. 設定可能な順序 — 環境に応じて調整可能
- **選択したアプローチ**: デフォルト順序を提供しつつ、設定で上書き可能
- **理由**: 企業環境やVPN環境で特定のソースを優先したいケースがある
- **デフォルト順序**: 環境変数 → VSCode設定 → プラットフォーム固有

## リスクと軽減策

- **リスク1**: ポーリング間隔短縮によるCPU/バッテリー消費増加
  - **軽減策**: 設定可能な間隔により、ユーザーが調整可能。デフォルトは30秒で適度なバランス

- **リスク2**: デバウンス処理による検出遅延
  - **軽減策**: 500msのデバウンス時間は体感的に即座に見える範囲。緊急時は手動でインポートコマンド使用可能

- **リスク3**: リトライによる遅延ユーザー体験
  - **軽減策**: 最大リトライ回数を3回に制限（計7秒）。ステータスバーで進行状況を表示

## 参考リンク

- [VSCode Extension API](https://code.visualstudio.com/api/references/vscode-api) — VSCode拡張機能のAPI仕様
- [TypeScript Debounce Pattern](https://gist.github.com/ca0v/73a31f57b397606c9813472f7493a940) — 型安全なデバウンス実装例
- [Exponential Backoff npm](https://www.npmjs.com/package/exponential-backoff) — 指数バックオフライブラリ（参考実装）
